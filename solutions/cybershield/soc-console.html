<!DOCTYPE html>
<html lang="es">
<head>
  <!-- =========================================================
    Archivo: /solutions/cybershield/soc-console.html
    Propósito: Consola SOC (demo) con filtros, tabla y tendencia.
    Cambios clave:
      - Favicons RomanoTI unificados (+ cache-buster)
      - Navbar estándar con dropdown "Solutions"
      - Estilo de marca (gradiente azul)
      - Hotfix universal del menú (/js/fix-nav.js) + fallback local
      - Lógica completa: fetch de alertas, Ack/Close (con fallback),
        auto-refresh y pequeña gráfica con Chart.js
  ========================================================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOC Console | RomanoTI Solutions</title>

  <!-- ===== Favicons RomanoTI ===== -->
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png?v=4">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32.png?v=4">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16.png?v=4">
  <link rel="shortcut icon" href="/favicon.ico?v=4" type="image/x-icon">
  <link rel="mask-icon" href="/img/safari-pinned-tab.svg?v=4" color="#2563eb">
  <meta name="theme-color" content="#2563eb">

  <!-- ===== Tailwind + Fuente ===== -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- ===== Chart.js (tendencia) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- ===== Estilos locales (marca + badges + compat dropdown) ===== -->
  <style>
    body{font-family:'Montserrat',sans-serif;background:#f8f9fa;color:#111827}
    .hero-bg{background:linear-gradient(135deg,#1e3a8a 0%,#2563eb 100%)} /* Azul unificado */
    .btn-primary{background:#2563EB;transition:all .2s}
    .btn-primary:hover{background:#1D4ED8;transform:translateY(-1px)}
    .badge{display:inline-flex;align-items:center;padding:.15rem .5rem;border-radius:.5rem;font-size:.75rem;font-weight:700}
    .sev-critical{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .sev-high{background:#ffedd5;color:#9a3412;border:1px solid #fed7aa}
    .sev-medium{background:#fef9c3;color:#92400e;border:1px solid #fde68a}
    .sev-low{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .status-new{background:#dbeafe;color:#1e3a8a;border:1px solid #bfdbfe}
    .status-ack{background:#e0e7ff;color:#3730a3;border:1px solid #c7d2fe}
    .status-closed{background:#e5e7eb;color:#374151;border:1px solid #d1d5db}
    pre.json{background:#0e1116;color:#eaeef3;padding:10px;border-radius:8px;max-height:40vh;overflow:auto}

    /* Compatibilidad para dropdown (legacy + hotfix) */
    .dropdown{display:none}
    .dropdown.show{display:block}
  </style>
</head>
<body class="bg-gray-50">

  <!-- =================== Header / Navbar =================== -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-6 py-3">
      <div class="flex items-center justify-between">
        <!-- Logo -->
        <a href="/" class="flex items-center font-bold text-xl">
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-blue-600 text-white mr-3">R</span>
          RomanoTI Solutions
        </a>

        <!-- Navegación (desktop) -->
        <nav class="hidden md:flex items-center space-x-6">
          <a href="/" class="text-gray-700 hover:text-blue-600">Home</a>

          <!-- Dropdown Solutions -->
          <div class="relative">
            <button id="solutionsBtn"
                    class="text-gray-700 hover:text-blue-600 inline-flex items-center focus:outline-none"
                    aria-haspopup="true" aria-expanded="false">
              Solutions
              <svg class="ml-1 w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.584l3.71-3.354a.75.75 0 111.02 1.1l-4.2 3.794a.75.75 0 01-1.02 0l-4.2-3.794a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
              </svg>
            </button>
            <div id="solutionsMenu"
                 class="hidden dropdown absolute right-0 mt-2 w-72 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 z-50">
              <a href="/solutions/" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Overview</a>
              <a href="/solutions/cybershield/" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">CyberShield (MDR)</a>
              <a href="/solutions/cybershield/soc-console.html" class="block px-4 py-2 text-sm text-blue-700 font-semibold bg-gray-50">SOC Console</a>
              <a href="/solutions/cybershield/easm-console.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">EASM Console</a>
              <a href="/solutions/cybershield/field-kit.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Field Kit</a>
            </div>
          </div>

          <a href="/services/tools.html" class="text-gray-700 hover:text-blue-600">Tools</a>
          <a href="/it-noc.html" class="text-gray-700 hover:text-blue-600">NOC</a>
          <a href="/it-soc.html" class="text-gray-700 hover:text-blue-600">SOC</a>
          <a href="https://calendly.com/mauricioromeroca" class="btn-primary text-white px-4 py-2 rounded-lg font-medium">Book Now</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- =================== Hero =================== -->
  <section class="hero-bg text-white py-12">
    <div class="container mx-auto px-6">
      <h1 class="text-3xl md:text-4xl font-bold">SOC Console</h1>
      <p class="text-lg opacity-90 mt-2">Visor de alertas, Ack/Cierre y tendencia (demo con endpoints reales si están disponibles).</p>
    </div>
  </section>

  <!-- =================== Main =================== -->
  <main class="container mx-auto px-6 py-8 space-y-8">

    <!-- Panel de conexión -->
    <section class="bg-white border rounded-xl shadow-sm p-5">
      <h2 class="text-xl font-semibold mb-2">Conexión</h2>
      <p class="text-gray-600 mb-4">Tu <b>Org API Key</b> sólo se usa como header <code>x-api-key</code> y se guarda en tu navegador.</p>
      <div class="grid md:grid-cols-3 gap-4 items-end">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Org API Key</label>
          <input id="orgKey" type="password" class="w-full border rounded-lg px-3 py-2" placeholder="MySecret123$">
          <p id="keyMsg" class="text-sm text-gray-500 mt-1"></p>
        </div>
        <div class="flex gap-3">
          <button id="btnSaveKey" class="btn-primary text-white px-4 py-2 rounded-lg">Guardar</button>
          <button id="btnRefresh" class="px-4 py-2 rounded-lg border">Refrescar</button>
        </div>
      </div>
    </section>

    <!-- Filtros / Auto-refresh -->
    <section class="bg-white border rounded-xl shadow-sm p-5">
      <div class="grid md:grid-cols-4 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Severidad</label>
          <select id="fltSeverity" class="w-full border rounded-lg px-3 py-2">
            <option value="">Todas</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Source (texto)</label>
          <input id="fltSource" class="w-full border rounded-lg px-3 py-2" placeholder="edr / firewall / email">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Límite</label>
          <input id="fltLimit" type="number" min="1" max="200" value="50" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div class="flex items-center gap-4">
          <label class="inline-flex items-center gap-2">
            <input id="autoRefresh" type="checkbox" class="rounded border-gray-300">
            <span>Auto-refresh (15s)</span>
          </label>
          <span id="lastRefresh" class="text-sm text-gray-500"></span>
        </div>
      </div>
    </section>

    <!-- Gráfica de tendencia -->
    <section class="bg-white border rounded-xl shadow-sm p-5">
      <h2 class="text-lg font-semibold mb-3">Tendencia (últimos 7 días)</h2>
      <canvas id="chartTrend" height="90"></canvas>
    </section>

    <!-- Tabla de alertas -->
    <section class="bg-white border rounded-xl shadow-sm p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Alertas recientes</h2>
        <div class="text-sm text-gray-500">Click en <b>Ack</b> o <b>Close</b> para actualizar estado.</div>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Time (UTC)</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Sev</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Source</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Title</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Status</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">SLA Ack</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Actions</th>
            </tr>
          </thead>
          <tbody id="tbAlerts" class="divide-y divide-gray-100 bg-white"></tbody>
        </table>
      </div>

      <details class="mt-4">
        <summary class="cursor-pointer text-sm text-gray-600">Payload seleccionado</summary>
        <pre id="alertJson" class="json mt-2"></pre>
      </details>
    </section>

  </main>

  <!-- =================== Lógica de consola =================== -->
  <script>
  (function(){
    /* ---------- Config & helpers ---------- */
    const API_BASE = 'https://romanoti-tools-api.onrender.com';
    const KEY_K = 'romanoti_org_key';

    const $ = (id)=>document.getElementById(id);
    const fmtUtc = (ts) => {
      try{
        const d = new Date(ts || Date.now());
        return new Intl.DateTimeFormat('en-CA',{
          dateStyle:'medium', timeStyle:'medium', timeZone:'UTC'
        }).format(d);
      }catch{ return String(ts||''); }
    };
    const by = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

    function badgeSev(s){
      const sev = String(s||'').toLowerCase();
      const map = {critical:'sev-critical',high:'sev-high',medium:'sev-medium',low:'sev-low'};
      return `<span class="badge ${map[sev]||'sev-low'}">${sev||'-'}</span>`;
    }
    function badgeStatus(s){
      const st = String(s||'new').toLowerCase();
      const map = {new:'status-new', acknowledged:'status-ack', ack:'status-ack', closed:'status-closed'};
      const label = st==='ack'?'acknowledged':st;
      return `<span class="badge ${map[st]||'status-new'}">${label}</span>`;
    }

    function loadKey(){ $('orgKey').value = localStorage.getItem(KEY_K)||''; }
    function saveKey(){
      const v = $('orgKey').value.trim();
      localStorage.setItem(KEY_K, v);
      $('keyMsg').textContent = v ? '✅ Guardada localmente.' : '';
    }

    async function apiGet(path){
      const key = $('orgKey').value.trim() || localStorage.getItem(KEY_K) || '';
      if(!key){ alert('Ingresa tu Org API Key'); throw new Error('missing key'); }
      const res = await fetch(API_BASE + path, { headers:{'x-api-key':key,'accept':'application/json'} });
      const text = await res.text();
      try{ return {ok:res.ok, status:res.status, data: JSON.parse(text)}; }
      catch{ return {ok:res.ok, status:res.status, data: text}; }
    }
    async function apiPost(path, body){
      const key = $('orgKey').value.trim() || localStorage.getItem(KEY_K) || '';
      if(!key){ alert('Ingresa tu Org API Key'); throw new Error('missing key'); }
      const res = await fetch(API_BASE + path, {
        method:'POST',
        headers:{'x-api-key':key,'content-type':'application/json','accept':'application/json'},
        body: JSON.stringify(body||{})
      });
      const text = await res.text();
      try{ return {ok:res.ok, status:res.status, data: JSON.parse(text)}; }
      catch{ return {ok:res.ok, status:res.status, data: text}; }
    }

    /* ---------- Estado en memoria ---------- */
    let alerts = [];         // lista renderizada
    let autoTimer = null;    // id de intervalo
    let chart;               // instancia Chart.js

    /* ---------- Render de tabla ---------- */
    function renderTable(){
      const tb = $('tbAlerts');
      tb.innerHTML = alerts.map(a => {
        const id = a.id || a._id || a.uuid || '';
        const sla = (a.sla_ack_ms!=null) ? Math.round(a.sla_ack_ms/1000)+'s' : '-';
        const status = a.status || (a.ack_ts?'acknowledged':'new');
        return `<tr data-id="${id}">
          <td class="px-3 py-2 text-sm">${fmtUtc(a.ts_utc || a.ts || a.time)}</td>
          <td class="px-3 py-2 text-sm">${badgeSev(a.severity)}</td>
          <td class="px-3 py-2 text-sm">${a.source||'-'}</td>
          <td class="px-3 py-2 text-sm">${a.title||a.msg||'(no title)'}</td>
          <td class="px-3 py-2 text-sm status-cell">${badgeStatus(status)}</td>
          <td class="px-3 py-2 text-sm">${sla}</td>
          <td class="px-3 py-2 text-sm">
            <button class="ack px-2 py-1 border rounded mr-2">Ack</button>
            <button class="close px-2 py-1 border rounded">Close</button>
          </td>
        </tr>`;
      }).join('');

      // wire actions
      by('button.ack', tb).forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const row = e.target.closest('tr'); const id=row?.dataset?.id;
          await ackAlert(id,row);
        });
      });
      by('button.close', tb).forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const row = e.target.closest('tr'); const id=row?.dataset?.id;
          await closeAlert(id,row);
        });
      });

      // click fila => ver JSON
      by('tr', tb).forEach(tr=>{
        tr.addEventListener('click', (e)=>{
          if(e.target.tagName==='BUTTON') return;
          const id = tr.dataset.id;
          const obj = alerts.find(x => (x.id||x._id||x.uuid) === id) || {};
          $('alertJson').textContent = JSON.stringify(obj, null, 2);
        });
      });
    }

    /* ---------- Tendencia (últimos 7 días) ---------- */
    function buildTrend(){
      const days = [...Array(7)].map((_,i)=>{
        const d = new Date(); d.setUTCDate(d.getUTCDate()- (6-i));
        d.setUTCHours(0,0,0,0);
        return d;
      });
      const counts = days.map((d)=>{
        const d0 = d.getTime(), d1 = d0 + 86400000;
        return alerts.filter(a=>{
          const t = new Date(a.ts_utc||a.ts||a.time||Date.now()).getTime();
          return t>=d0 && t<d1;
        }).length;
      });
      const labels = days.map(d => d.toISOString().slice(5,10)); // MM-DD

      const ctx = $('chartTrend').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Alerts', data:counts, tension:0.3 }] },
        options:{ responsive:true, plugins:{legend:{display:false}} }
      });
    }

    /* ---------- Carga de alertas ---------- */
    async function loadAlerts(){
      const limit = Math.max(1, Math.min(200, parseInt(($('fltLimit').value||'50'),10)));
      const sev   = ($('fltSeverity').value||'').toLowerCase();
      const srcQ  = $('fltSource').value.trim().toLowerCase();

      const resp = await apiGet(`/soc/alerts/recent?limit=${encodeURIComponent(limit)}`);
      let arr = [];

      // Aceptar varios formatos de respuesta (flexible para la demo)
      if(Array.isArray(resp.data)) arr = resp.data;
      else if(resp.data && Array.isArray(resp.data.alerts)) arr = resp.data.alerts;
      else if(resp.data && Array.isArray(resp.data.items)) arr = resp.data.items;

      // Filtros locales (por si el backend no los soporta)
      if(sev)  arr = arr.filter(a => String(a.severity||'').toLowerCase()===sev);
      if(srcQ) arr = arr.filter(a => String(a.source||'').toLowerCase().includes(srcQ));

      // Orden descendente por tiempo (si existe)
      arr.sort((a,b)=> new Date(b.ts_utc||b.ts||b.time||0) - new Date(a.ts_utc||a.ts||a.time||0));

      alerts = arr;
      renderTable();
      buildTrend();
      $('lastRefresh').textContent = 'Actualizado: ' + new Date().toLocaleTimeString();
    }

    /* ---------- Acciones: Ack / Close (con fallback) ---------- */
    async function ackAlert(id, row){
      if(!id) return;
      // Intento de endpoint real:
      const r = await apiPost('/soc/alerts/ack', { id }).catch(()=>({ok:false}));
      if(r && r.ok){
        row.querySelector('.status-cell').innerHTML = badgeStatus('acknowledged');
      }else{
        // Fallback local: actualizar badge y seguir
        row.querySelector('.status-cell').innerHTML = badgeStatus('acknowledged');
        alert('Ack local aplicado (endpoint /soc/alerts/ack no disponible).');
      }
    }
    async function closeAlert(id, row){
      if(!id) return;
      const r = await apiPost('/soc/alerts/close', { id }).catch(()=>({ok:false}));
      if(r && r.ok){
        row.querySelector('.status-cell').innerHTML = badgeStatus('closed');
      }else{
        row.querySelector('.status-cell').innerHTML = badgeStatus('closed');
        alert('Close local aplicado (endpoint /soc/alerts/close no disponible).');
      }
    }

    /* ---------- Auto-refresh ---------- */
    function setAutoRefresh(on){
      if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
      if(on){ autoTimer = setInterval(loadAlerts, 15000); }
    }

    /* ---------- Wire-up inicial ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      loadKey();
      $('btnSaveKey').addEventListener('click', saveKey);
      $('btnRefresh').addEventListener('click', loadAlerts);
      $('fltSeverity').addEventListener('change', loadAlerts);
      $('fltSource').addEventListener('input', ()=>{ /* debounce light */ clearTimeout(window._t); window._t=setTimeout(loadAlerts,300); });
      $('fltLimit').addEventListener('change', loadAlerts);
      $('autoRefresh').addEventListener('change', (e)=> setAutoRefresh(e.target.checked));

      // Primera carga
      loadAlerts();
    });
  })();
  </script>

  <!-- =================== Fallback de dropdown (no interfiere con fix-nav) =================== -->
  <script>
    (function(){
      const btn  = document.getElementById('solutionsBtn');
      const menu = document.getElementById('solutionsMenu');
      if(!btn || !menu) return;

      function open(){ menu.classList.add('show'); menu.classList.remove('hidden'); menu.style.display='block'; btn.setAttribute('aria-expanded','true'); }
      function close(){ menu.classList.remove('show'); menu.classList.add('hidden'); menu.style.display=''; btn.setAttribute('aria-expanded','false'); }
      function isOpen(){ return menu.classList.contains('show') || !menu.classList.contains('hidden') || menu.style.display==='block'; }
      function toggle(){ isOpen()? close() : open(); }

      btn.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); toggle(); });
      document.addEventListener('click',(e)=>{ if(!menu.contains(e.target) && e.target!==btn) close(); });
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close(); });

      // Hover como refuerzo UX
      btn.addEventListener('mouseenter', open);
      btn.parentNode.addEventListener('mouseleave', ()=>setTimeout(close,120));
    })();
  </script>

  <!-- =================== Hotfix universal del menú =================== -->
<!-- siempre justo antes de </body> y solo una vez por página -->
<script defer src="/js/nav.js?v=2025-01"></script>
<script defer src="/js/footer.js?v=2025-01"></script>
<script defer src="/js/fix-nav.js?v=2025-01"></script>
</body>
</html>

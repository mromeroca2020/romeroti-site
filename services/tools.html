<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>RomanoTI Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; margin:24px; max-width:900px}
    .card{border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    input,button,select{padding:10px;border:1px solid #ccc;border-radius:8px}
    button{cursor:pointer}
    pre{background:#0e1116;color:#eaeef3;padding:12px;border-radius:8px;overflow:auto;max-height:60vh;white-space:pre}
    .hidden{display:none}
    small.muted{color:#6b7280}
  </style>
</head>
<body>
  <h1>RomanoTI Tools</h1>

  <!-- 1) TARJETA: ejecuta la Netlify Function (no requiere login) -->
  <div class="card">
    <h3>Server Diagnostic (Netlify Function)</h3>
    <div class="row">
      <button onclick="runTool()">⚡ Run Diagnostic Tool (Netlify)</button>
      <small class="muted">Este botón llama a <code>/.netlify/functions/run-tool</code> y muestra el JSON “bonito” en la salida de abajo. No requiere login aquí.</small>
    </div>
  </div>

  <!-- 2) TARJETA NUEVA: Control Plane + Agente On-Prem (Inventario de LAN) -->
  <div class="card" id="lan-agent" style="margin-top:16px">
    <h3>On-Prem Agent (LAN Inventory)</h3>
    <p class="muted">
      Instala este agente en una PC/VM dentro de tu red. Hará un inventario básico (hosts activos, IP local, etc.)
      y enviará el reporte al Control Plane de RomanoTI.
    </p>

    <!-- Configuración del Control Plane -->
    <div class="row" style="align-items:flex-end">
      <div>
        <label for="cpApi"><b>Control Plane API URL</b></label><br/>
        <input id="cpApi" placeholder="https://romanoti-tools-api.onrender.com" style="min-width:380px"/>
        <small class="muted">Se guarda en <code>localStorage</code>.</small>
      </div>
      <div>
        <label for="cpKey"><b>Org API Key</b></label><br/>
        <input id="cpKey" type="password" placeholder="pega aquí tu x-api-key" style="min-width:260px"/>
        <small class="muted">Se guarda en <code>localStorage</code>.</small>
      </div>
      <div>
        <button onclick="saveCP()">Guardar</button>
      </div>
    </div>

    <!-- Parámetros del agente -->
    <div class="row" style="align-items:flex-end; margin-top:12px">
      <div>
        <label for="agentName"><b>Agent name (opcional)</b></label><br/>
        <input id="agentName" placeholder="ej: rome-office-01"/>
      </div>
      <div>
        <button onclick="showLinuxCommand()">Linux / macOS</button>
        <button onclick="showWindowsCommand()">Windows</button>
        <button onclick="copyCmd()">Copiar comando</button>
      </div>
    </div>

    <pre id="agentCmd" style="margin-top:12px"></pre>

    <div style="margin-top:8px">
      <small class="muted">
        El comando descarga el agente, configura <code>ROMANOTI_API</code> y <code>ROMANOTI_KEY</code>, y ejecuta un
        escaneo rápido. Luego hace POST a <code>/client/report</code>.
      </small>
    </div>

    <hr style="margin:16px 0"/>

    <div class="row">
      <button onclick="latestReport()">Ver último reporte</button>
    </div>
    <pre id="agentOut" style="margin-top:12px"></pre>
  </div>

  <!-- 3) TARJETA: Login para herramientas autenticadas -->
  <div class="card" id="loginCard">
    <h3>Login</h3>
    <div class="row">
      <input id="user" placeholder="username (ej: eng1)" />
      <input id="pass" placeholder="password" type="password" />
      <button onclick="login()">Iniciar sesión</button>
    </div>
    <small class="muted">
      API: <code id="apiBaseShown"></code>. Puedes sobreescribirla con
      <code>localStorage.setItem('romanoti_api','http://127.0.0.1:8000')</code>
      y recargar.
    </small>
    <br />
    <small>El token se guarda en <code>sessionStorage</code> (se borra al cerrar la pestaña).</small>
    <div id="loginMsg"></div>
  </div>

  <div class="card hidden" id="toolsCard">
    <div class="row" style="align-items:center; justify-content:space-between">
      <div>
        <h3>Herramientas</h3>
        <small>Autenticado como: <b id="whoami"></b></small>
      </div>
      <button onclick="logout()">Cerrar sesión</button>
    </div>

    <div class="card">
      <h4>Sistema</h4>
      <button onclick="call('GET','/system/info')">/system/info</button>
      <button onclick="call('GET','/network/info')">/network/info</button>
    </div>

    <div class="card">
      <h4>Ping</h4>
      <div class="row">
        <input id="pingHost" placeholder="host (ej: 8.8.8.8)" value="8.8.8.8" />
        <input id="pingCount" type="number" min="1" max="10" value="4" />
        <button onclick="ping()">Enviar</button>
      </div>
      <small class="muted">Nota: si el backend aún no implementa <code>/network/ping</code>, verás “endpoint no disponible”.</small>
    </div>

    <div class="card">
      <h4>Traceroute</h4>
      <div class="row">
        <input id="traceHost" placeholder="host (ej: 8.8.8.8)" value="8.8.8.8" />
        <button onclick="trace()">Enviar</button>
      </div>
      <small class="muted">Nota: si el backend aún no implementa <code>/network/traceroute</code>, verás “endpoint no disponible”.</small>
    </div>

    <div class="card">
      <h4>Port Scan</h4>
      <div class="row">
        <input id="scanHost" placeholder="host (IP/hostname)" />
        <input id="scanStart" type="number" min="1" max="65535" value="1" />
        <input id="scanEnd" type="number" min="1" max="65535" value="1024" />
      </div>
      <div class="row">
        <input id="scanPorts" placeholder="puertos (opcional: 80,443,22)" style="min-width:280px" />
        <button onclick="portscan()">Escanear</button>
      </div>
      <small class="muted">Si indicas “puertos”, se ignoran start/end. Compatible con tu endpoint actual.</small>
    </div>
  </div>

  <h4>Salida</h4>
  <pre id="out"></pre>

<script>
  // =========================================================
  // Helpers
  // =========================================================
  const $ = (id) => document.getElementById(id);
  const token = () => sessionStorage.getItem('romanoti_token');
  function show(id, on=true){ $(id).classList[on?'remove':'add']('hidden'); }
  function log(obj){
    const out = $("out");
    try { out.textContent = (typeof obj==='string') ? obj : JSON.stringify(obj,null,2); }
    catch { out.textContent = String(obj); }
  }

  // =========================================================
  // Configuración general (API protegida)
  // =========================================================
  // Si no hay override, usamos también el CP_API como API_BASE
  let API_BASE = localStorage.getItem('romanoti_api') || 'https://romanoti-tools-api.onrender.com';
  $('apiBaseShown').textContent = API_BASE;

  // =========================================================
  // 1) Netlify function: pretty JSON (muestra solo "output")
  // =========================================================
  async function runTool() {
    $("out").textContent = 'Running…';
    try {
      const res = await fetch('/.netlify/functions/run-tool?pretty=1&indent=2', {
        headers: { 'Accept': 'application/json' }
      });
      const text = await res.text();
      try {
        const data = JSON.parse(text);
        const toShow = (data && typeof data === 'object' && 'output' in data) ? data.output : data;
        $("out").textContent = JSON.stringify(toShow, null, 2);
      } catch { $("out").textContent = text; }
    } catch (err) {
      $("out").textContent = '❌ Error: ' + String(err);
    }
  }

  // =========================================================
  // 2) Login normal (para endpoints protegidos)
  // =========================================================
  async function login(){
    $("loginMsg").textContent = "Autenticando...";
    try{
      const body = new URLSearchParams();
      body.append('username', $('user').value);
      body.append('password', $('pass').value);
      const res = await fetch(`${API_BASE}/auth/token`, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body
      });
      if(!res.ok){
        $("loginMsg").innerHTML = `<span style="color:#c33">Login falló: ${res.status}</span>`;
        return;
      }
      const data = await res.json(); // {access_token, token_type}
      sessionStorage.setItem('romanoti_token', data.access_token);
      $("whoami").textContent = $('user').value;
      show('loginCard', false); show('toolsCard', true);
      log({login:'ok', ...data});
      $("loginMsg").textContent = "OK";
    }catch(e){
      $("loginMsg").innerHTML = `<span style="color:#c33">${e}</span>`;
    }
  }
  function logout(){
    sessionStorage.removeItem('romanoti_token');
    show('toolsCard', false); show('loginCard', true);
    $("out").textContent = '';
  }

  // Llamador genérico autenticado
  async function call(method, path, body=null){
    try{
      const res = await fetch(`${API_BASE}${path}`, {
        method,
        headers:{
          'Authorization': `Bearer ${token()}`,
          'Content-Type': 'application/json'
        },
        body: body ? JSON.stringify(body) : null
      });
      const text = await res.text();
      if (!res.ok) {
        if (res.status === 404) log({ error: 'endpoint no disponible', path, status: res.status, body: text });
        else log({ error: 'HTTP error', path, status: res.status, body: text });
        return;
      }
      try{ log(JSON.parse(text)); }catch{ log(text); }
    }catch(e){ log(String(e)); }
  }

  async function ping(){
    await call('POST','/network/ping', {
      host: $('pingHost').value,
      count: Number($('pingCount').value||4)
    });
  }
  async function trace(){ await call('POST','/network/traceroute', { host: $('traceHost').value }); }
  async function portscan(){
    const payload = {
      host: $('scanHost').value,
      start: Number($('scanStart').value||1),
      end: Number($('scanEnd').value||1024)
    };
    const portsStr = $('scanPorts').value.trim();
    if (portsStr) payload.ports = portsStr.split(',').map(p => parseInt(p.trim(),10)).filter(Boolean);
    await call('POST','/network/portscan', payload);
  }

  // =========================================================
  // 3) Control Plane + Agente On-Prem
  // =========================================================
  const ASSETS_BASE = '/assets/agent'; // sube aquí los binarios (romanoti-agent, romanoti-agent.exe)

  // Cargamos CP_API/KEY desde localStorage y pintamos en inputs
  let CP_API = localStorage.getItem('romanoti_cp_api') || 'https://romanoti-tools-api.onrender.com';
  let CP_KEY = localStorage.getItem('romanoti_cp_key') || '';
  document.addEventListener('DOMContentLoaded', () => {
    if ($('cpApi')) $('cpApi').value = CP_API;
    if ($('cpKey')) $('cpKey').value = CP_KEY;
  });

  function saveCP(){
    CP_API = ($('cpApi')?.value || '').trim();
    CP_KEY = ($('cpKey')?.value || '').trim();
    localStorage.setItem('romanoti_cp_api', CP_API);
    localStorage.setItem('romanoti_cp_key', CP_KEY);
    // si no hay override de romanoti_api, usa CP_API también
    if (!localStorage.getItem('romanoti_api')) {
      API_BASE = CP_API;
      $('apiBaseShown').textContent = API_BASE;
    }
    log({ok:true, message:'Control Plane guardado', CP_API, key_set: !!CP_KEY});
  }

  // Construcción de comandos
  let lastCmd = '';
  function buildLinuxCmd() {
    const name = $('agentName').value.trim();
    const tag  = name ? ` ROMANOTI_AGENT="${name}"` : '';
    return [
      `curl -L ${location.origin}${ASSETS_BASE}/romanoti-agent -o romanoti-agent`,
      `chmod +x romanoti-agent`,
      `ROMANOTI_API="${CP_API}" ROMANOTI_KEY="${CP_KEY}"${tag} ./romanoti-agent`
    ].join(' && ');
  }
  function buildWindowsCmd() {
    const name = $('agentName').value.trim();
    const nameSet = name ? `; setx ROMANOTI_AGENT '${name}'` : '';
    return `powershell -NoProfile -ExecutionPolicy Bypass -Command "Invoke-WebRequest -Uri '${location.origin}${ASSETS_BASE}/romanoti-agent.exe' -OutFile 'romanoti-agent.exe'; setx ROMANOTI_API '${CP_API}'; setx ROMANOTI_KEY '${CP_KEY}'${nameSet}; .\\romanoti-agent.exe"`;
  }
  function showLinuxCommand(){ lastCmd = buildLinuxCmd(); $('agentCmd').textContent = lastCmd; }
  function showWindowsCommand(){ lastCmd = buildWindowsCmd(); $('agentCmd').textContent = lastCmd; }
  function copyCmd(){ if (lastCmd) navigator.clipboard.writeText(lastCmd); }

  // Consultar último reporte del Control Plane
  async function latestReport(){
    if (!CP_API || !CP_KEY){
      $('agentOut').textContent = 'Configura primero Control Plane URL y Org API Key (botón Guardar).';
      return;
    }
    $('agentOut').textContent = 'Consultando…';
    try{
      const res = await fetch(`${CP_API}/client/reports/latest`, {
        headers: { 'x-api-key': CP_KEY, 'accept': 'application/json' }
      });
      const text = await res.text();
      try{ $('agentOut').textContent = JSON.stringify(JSON.parse(text), null, 2); }
      catch{ $('agentOut').textContent = text; }
    }catch(e){
      $('agentOut').textContent = String(e);
    }
  }

  // Si ya hay token en la sesión, mostramos herramientas directamente.
  if(token()){ show('loginCard', false); show('toolsCard', true); $("whoami").textContent = 'session'; }
</script>
</body>
</html>

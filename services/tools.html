<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>RomanoTI Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; margin:24px; max-width:900px}
    .card{border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    input,button,select{padding:10px;border:1px solid #ccc;border-radius:8px}
    button{cursor:pointer}
    pre{background:#0e1116;color:#eaeef3;padding:12px;border-radius:8px;overflow:auto}
    .hidden{display:none}
    small.muted{color:#6b7280}
  </style>
</head>
<body>
  <h1>RomanoTI Tools</h1>

  <div class="card" id="loginCard">
    <h3>Login</h3>
    <div class="row">
      <input id="user" placeholder="username (ej: eng1)" />
      <input id="pass" placeholder="password" type="password" />
      <button onclick="login()">Iniciar sesi√≥n</button>
    </div>
    <small class="muted">
      API: <code id="apiBaseShown"></code>. Puedes sobreescribirla con
      <code>localStorage.setItem('romanoti_api','http://127.0.0.1:8000')</code>
      y recargar.
    </small>
    <br />
    <small>El token se guarda en <code>sessionStorage</code> (se borra al cerrar la pesta√±a).</small>
    <div id="loginMsg"></div>
  </div>

  <div class="card hidden" id="toolsCard">
    <div class="row" style="align-items:center; justify-content:space-between">
      <div>
        <h3>Herramientas</h3>
        <small>Autenticado como: <b id="whoami"></b></small>
      </div>
      <button onclick="logout()">Cerrar sesi√≥n</button>
    </div>

    <div class="card">
      <h4>Sistema</h4>
      <button onclick="call('GET','/system/info')">/system/info</button>
      <button onclick="call('GET','/network/info')">/network/info</button>
    </div>

    <div class="card">
      <h4>Ping</h4>
      <div class="row">
        <input id="pingHost" placeholder="host (ej: 8.8.8.8)" value="8.8.8.8" />
        <input id="pingCount" type="number" min="1" max="10" value="4" />
        <button onclick="ping()">Enviar</button>
      </div>
      <small class="muted">Nota: si el backend a√∫n no implementa <code>/network/ping</code>, ver√°s ‚Äúendpoint no disponible‚Äù.</small>
    </div>

    <div class="card">
      <h4>Traceroute</h4>
      <div class="row">
        <input id="traceHost" placeholder="host (ej: 8.8.8.8)" value="8.8.8.8" />
        <button onclick="trace()">Enviar</button>
      </div>
      <small class="muted">Nota: si el backend a√∫n no implementa <code>/network/traceroute</code>, ver√°s ‚Äúendpoint no disponible‚Äù.</small>
    </div>

    <div class="card">
      <h4>Port Scan</h4>
      <div class="row">
        <input id="scanHost" placeholder="host (IP/hostname)" />
        <input id="scanStart" type="number" min="1" max="65535" value="1" />
        <input id="scanEnd" type="number" min="1" max="65535" value="1024" />
      </div>
      <div class="row">
        <input id="scanPorts" placeholder="puertos (opcional: 80,443,22)" style="min-width:280px" />
        <button onclick="portscan()">Escanear</button>
      </div>
      <small class="muted">Si indicas ‚Äúpuertos‚Äù, se ignoran start/end. Compatible con tu endpoint actual.</small>
    </div>

    <h4>Salida</h4>
    <pre id="out"></pre>
  </div>

<script>
  // üëâ Por defecto usamos la API publicada en Render; puedes sobreescribir por localStorage para pruebas locales.
  const API_BASE = localStorage.getItem('romanoti_api') || 'https://romanoti-tools-api.onrender.com';
  document.getElementById('apiBaseShown').textContent = API_BASE;

  const $ = (id) => document.getElementById(id);
  const token = () => sessionStorage.getItem('romanoti_token');

  function show(id, on=true){ $(id).classList[on?'remove':'add']('hidden'); }
  function log(obj){
    const out = $("out");
    try {
      out.textContent = (typeof obj==='string') ? obj : JSON.stringify(obj,null,2);
    } catch {
      out.textContent = String(obj);
    }
  }

  async function login(){
    $("loginMsg").textContent = "Autenticando...";
    try{
      const body = new URLSearchParams();
      body.append('username', $('user').value);
      body.append('password', $('pass').value);
      const res = await fetch(`${API_BASE}/auth/token`, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body
      });
      if(!res.ok){
        $("loginMsg").innerHTML = `<span style="color:#c33">Login fall√≥: ${res.status}</span>`;
        return;
      }
      const data = await res.json(); // {access_token, token_type}
      sessionStorage.setItem('romanoti_token', data.access_token);
      $("whoami").textContent = $('user').value;
      show('loginCard', false); show('toolsCard', true);
      log({login:'ok', ...data});
      $("loginMsg").textContent = "OK";
    }catch(e){
      $("loginMsg").innerHTML = `<span style="color:#c33">${e}</span>`;
    }
  }

  function logout(){
    sessionStorage.removeItem('romanoti_token');
    show('toolsCard', false); show('loginCard', true);
    $("out").textContent = '';
  }

  async function call(method, path, body=null){
    try{
      const res = await fetch(`${API_BASE}${path}`, {
        method,
        headers:{
          'Authorization': `Bearer ${token()}`,
          'Content-Type': 'application/json'
        },
        body: body ? JSON.stringify(body) : null
      });
      const text = await res.text();
      if (!res.ok) {
        if (res.status === 404) {
          log({ error: 'endpoint no disponible', path, status: res.status, body: text });
        } else {
          log({ error: 'HTTP error', path, status: res.status, body: text });
        }
        return;
      }
      try{ log(JSON.parse(text)); }catch{ log(text); }
    }catch(e){
      log(String(e));
    }
  }

  async function ping(){
    await call('POST','/network/ping', {
      host: $('pingHost').value,
      count: Number($('pingCount').value||4)
    });
  }

  async function trace(){
    await call('POST','/network/traceroute', { host: $('traceHost').value });
  }

  async function portscan(){
    const payload = {
      host: $('scanHost').value,
      start: Number($('scanStart').value||1),
      end: Number($('scanEnd').value||1024)
    };
    const portsStr = $('scanPorts').value.trim();
    if (portsStr) {
      payload.ports = portsStr.split(',').map(p => parseInt(p.trim(),10)).filter(Boolean);
    }
    await call('POST','/network/portscan', payload);
  }

  // Si ya hay token en la sesi√≥n, mostramos herramientas directamente.
  if(token()){ show('loginCard', false); show('toolsCard', true); $("whoami").textContent = 'session'; }
</script>
</body>
</html>
